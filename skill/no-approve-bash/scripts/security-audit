#!/bin/bash
# ~/.claude-bin å®‰å…¨å®¡æŸ¥è„šæœ¬
# ç”¨æ³•: security-audit [ç›®å½•]

SCAN_DIR="${1:-$HOME/.claude-bin}"

echo "ğŸ” å®¡æŸ¥è„šæœ¬å®‰å…¨æ€§: $SCAN_DIR"
echo "================================"

# å±é™©å‘½ä»¤æ¨¡å¼
DANGEROUS_PATTERNS=(
    "rm -rf /"
    "rm -rf ~/"
    "rm -rf /home"
    "rm -rf /usr"
    "rm -rf /etc"
    "rm -rf \.git"
    "rm -rf \.\./\.\./\.\."
    "mv .* /dev/"
    "dd if="
    "mkfs"
    ":(){ :|:& };:"
    "chmod 000 /"
    "chown -R root"
    "shutdown"
    "reboot"
    "init 0"
)

found_issues=0

for script in "$SCAN_DIR"/*; do
    if [ -f "$script" ]; then
        script_name=$(basename "$script")
        echo ""
        echo "ğŸ“„ $script_name"

        for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -q "$pattern" "$script" 2>/dev/null; then
                echo "   âš ï¸  å‘ç°å±é™©æ¨¡å¼: $pattern"
                ((found_issues++))
            fi
        done

        # æ£€æŸ¥æ˜¯å¦æœ‰ shebang
        if ! head -1 "$script" | grep -q '^#!'; then
            echo "   âš ï¸  ç¼ºå°‘ shebang"
        fi

        # æ˜¾ç¤ºè„šæœ¬å¤§å°
        size=$(wc -l < "$script" 2>/dev/null)
        echo "   ğŸ“ è¡Œæ•°: $size"
    fi
done

echo ""
echo "================================"
if [ $found_issues -eq 0 ]; then
    echo "âœ… æœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜"
else
    echo "âš ï¸  å‘ç° $found_issues ä¸ªæ½œåœ¨é—®é¢˜ï¼Œè¯·äººå·¥å®¡æŸ¥"
fi
